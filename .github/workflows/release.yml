name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Get version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        BINARY_NAME="hostmanager"
        if [ "${{ matrix.goos }}" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi
        
        go build -ldflags="-s -w" -o "${BINARY_NAME}" .
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        PACKAGE_NAME="hostmanager-${{ steps.version.outputs.VERSION }}-${{ matrix.goos }}-${{ matrix.goarch }}"
        mkdir -p "${PACKAGE_NAME}"
        
        # å¤åˆ¶æ–‡ä»¶åˆ°å‘å¸ƒåŒ…
        cp "${BINARY_NAME}" "${PACKAGE_NAME}/"
        cp config.example.yaml "${PACKAGE_NAME}/config.yaml"
        cp install.sh "${PACKAGE_NAME}/"
        cp install-global.sh "${PACKAGE_NAME}/"
        cp completion.bash "${PACKAGE_NAME}/"
        cp completion.zsh "${PACKAGE_NAME}/"
        cp README.md "${PACKAGE_NAME}/"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        if [ "${{ matrix.goos }}" = "windows" ]; then
          zip -r "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}"
        else
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
        fi

    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: hostmanager-${{ steps.version.outputs.VERSION }}-${{ matrix.goos }}-${{ matrix.goarch }}.*
        file_glob: true
        tag: ${{ github.ref }}
        overwrite: true
        body: |
          ## HostManager ${{ steps.version.outputs.VERSION }}
          
          ### æ–°åŠŸèƒ½
          - âœ¨ æ”¯æŒ Zmodem æ–‡ä»¶ä¼ è¾“ (sz/rz å‘½ä»¤)
          - ğŸ”§ æ”¹è¿›é…ç½®æ–‡ä»¶æŸ¥æ‰¾é€»è¾‘
          - ğŸ“¦ æä¾›å¤šå¹³å°é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
          
          ### å®‰è£…æ–¹æ³•
          
          #### æ–¹æ³• 1: ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
          1. ä»ä¸‹æ–¹é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„æ–‡ä»¶ä¸‹è½½
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `./install-global.sh` è¿›è¡Œå…¨å±€å®‰è£…
          
          #### æ–¹æ³• 2: ä½¿ç”¨ Go å®‰è£…
          ```bash
          go install github.com/daihao4371/hostmanager@${{ steps.version.outputs.VERSION }}
          ```
          
          ### ä½¿ç”¨è¯´æ˜
          - `hm` - å¯åŠ¨äº¤äº’å¼ç•Œé¢
          - `hm list` - åˆ—å‡ºæ‰€æœ‰ä¸»æœº
          - `hm connect <ä¸»æœºå>` - è¿æ¥æŒ‡å®šä¸»æœº
          
          ### Zmodem æ”¯æŒ
          è¿æ¥åˆ°æœåŠ¡å™¨åå¯ç›´æ¥ä½¿ç”¨ï¼š
          - `sz filename` - å‘é€æ–‡ä»¶åˆ°æœ¬åœ°
          - `rz` - æ¥æ”¶æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹
          
          éœ€è¦å…ˆå®‰è£… lrzsz: `brew install lrzsz` (macOS) æˆ– `apt install lrzsz` (Ubuntu)